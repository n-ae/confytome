# ADR-018: Dependency Architecture Simplification

**Date:** 2025-09-19
**Status:** Active
**Architect:** Claude (Maintainable-Architect)
**Context:** Resolving architectural inconsistency between standalone promises and code duplication

## Executive Summary

This ADR reverses the code duplication approach from ADR-014 and ADR-017, establishing that **simplicity through proper dependencies is superior to false independence through code duplication**. When shared utilities exist in core, packages should depend on them rather than duplicating hundreds of lines of code.

## Problem Statement

Current architecture creates a false dichotomy between "standalone" and "dependent" packages:

### Issues with Current Approach:
1. **Code Duplication**: Each package would duplicate ~400 lines of `StandaloneBase.js` and `OpenApiProcessor.js`
2. **Maintenance Burden**: Bug fixes and improvements must be applied to multiple copies
3. **False Independence**: Packages claim to be standalone but require complex local utilities
4. **Architectural Confusion**: Users expect `npx @confytome/markdown` to work, but internal architecture fights this

### Real User Problem:
```bash
# User expectation - simple command that works
npx @confytome/markdown -c confytome.json

# Current failure - missing dependencies break the promise
Error [ERR_MODULE_NOT_FOUND]: Cannot find package '@confytome/core'
```

## Architectural Decision

### Principle: Simplicity Over False Independence

**Decision:** Standalone packages should properly depend on `@confytome/core` rather than duplicating code.

### Rationale:
1. **DRY Principle**: Don't repeat yourself - shared code should live in one place
2. **Maintenance**: Bug fixes and improvements happen once in core
3. **User Experience**: `npx @confytome/markdown` works reliably with proper dependencies
4. **Honest Architecture**: Dependencies are explicit and manageable

### Implementation:

#### 1. Proper Dependency Declaration
```json
// packages/*/package.json
{
  "dependencies": {
    "@confytome/core": "^1.7.18",
    "commander": "^14.0.1",
    "mustache": "^4.2.0"
  }
}
```

#### 2. Clean Import Structure
```javascript
// packages/markdown/standalone-generator.js
import { StandaloneBase } from '@confytome/core/utils/StandaloneBase.js';
import { OpenApiProcessor } from '@confytome/core/utils/OpenApiProcessor.js';
```

#### 3. NPX Installation Behavior
- `npx @confytome/markdown` automatically installs `@confytome/core` as a dependency
- User gets working command with proper dependencies
- No hidden surprises or missing functionality

## Comparison with Previous ADRs

### ADR-014 & ADR-017: Code Duplication Approach ❌
**Problem:** Created 4 copies of ~400 lines of shared utilities per package
**Result:** Would require maintaining identical code in 5+ locations
**Maintenance:** Every bug fix needs 5+ identical changes

### ADR-018: Dependency Approach ✅
**Solution:** Single source of truth for shared utilities in `@confytome/core`
**Result:** Shared code maintained in one location
**Maintenance:** Bug fixes and improvements happen once

## Benefits of Dependency Approach

### 1. True Simplicity ✅
- One place to maintain shared utilities
- One place to fix bugs and add features
- Clear dependency relationships

### 2. Reliable User Experience ✅
```bash
npx @confytome/markdown -c confytome.json  # Always works
npx @confytome/confluence -s api.json      # Always works
npx @confytome/swagger --spec api.json     # Always works
```

### 3. Maintainable Architecture ✅
- Core utilities: 1 implementation, tested once
- Package-specific code: Only what's unique to that package
- Clear separation of shared vs specific functionality

### 4. Honest Dependencies ✅
```json
{
  "dependencies": {
    "@confytome/core": "^1.7.18"  // Explicit, honest, manageable
  }
}
```

## User Impact

### Before (Broken):
- `npx @confytome/markdown` fails with module not found errors
- Inconsistent behavior across packages
- Hidden complexity in "standalone" packages

### After (Working):
- `npx @confytome/markdown` works reliably
- Consistent behavior across all packages
- Clear, honest dependencies

## Package Size Comparison

### Code Duplication Approach:
- Core: 400 lines of utilities
- Markdown: 400 lines duplicated + package code
- Confluence: 400 lines duplicated + package code
- Swagger: 400 lines duplicated + package code
- HTML: 400 lines duplicated + package code
- **Total: 2000+ lines of duplicated utilities**

### Dependency Approach:
- Core: 400 lines of utilities (maintained once)
- Markdown: Package-specific code only
- Confluence: Package-specific code only
- Swagger: Package-specific code only
- HTML: Package-specific code only
- **Total: 400 lines of shared utilities**

## Implementation Guidelines

### 1. Shared Utilities in Core
- `StandaloneBase.js` - Common base functionality
- `OpenApiProcessor.js` - OpenAPI processing logic
- Service utilities - Branding, versioning, etc.

### 2. Package-Specific Code Only
- CLI implementation
- Format-specific generation logic
- Package-specific templates
- Unique dependencies (mustache, marked, etc.)

### 3. Clear Dependencies
- All packages explicitly depend on `@confytome/core`
- No hidden or implicit dependencies
- Standard npm dependency resolution

## Success Metrics

### Immediate (Within 24 Hours):
- ✅ `npx @confytome/markdown -c confytome.json` works
- ✅ `npx @confytome/confluence -s api.json` works
- ✅ All standalone commands work reliably

### Medium Term (1 Month):
- ✅ Zero code duplication in shared utilities
- ✅ Bug fixes apply to all packages automatically
- ✅ New features in core benefit all packages

### Long Term (3 Months):
- ✅ Faster development of new generators
- ✅ Consistent behavior across all packages
- ✅ Reduced maintenance burden

## Architectural Wisdom

### Key Insight: Simplicity Beats Complexity

**False Independence is Complex**: Duplicating code to avoid dependencies creates more complexity, not less.

**True Simplicity**: Proper dependencies with shared utilities maintained in one place.

### The Right Abstraction

- **Core Package**: Shared utilities and OpenAPI generation
- **Format Packages**: Format-specific generation only
- **Clear Interface**: Well-defined imports and exports

## Conclusion

This ADR establishes that **dependency-based architecture is simpler and more maintainable than code duplication**. By properly depending on `@confytome/core`, standalone packages:

1. Work reliably for users
2. Avoid code duplication
3. Benefit from shared improvements
4. Maintain clear architectural boundaries

**Architectural Principle**: When choosing between dependencies and duplication, choose dependencies. They create honest, maintainable relationships between packages.

The goal is not theoretical independence but practical simplicity that works for both users and maintainers.

---

*This ADR supersedes the code duplication approach from ADR-014 and ADR-017, establishing dependency-based architecture as the simpler, more maintainable solution.*