# Bug Fix: Header Duplication in Code Samples

**Date:** 2025-10-01
**Priority:** High (User-Facing Bug)
**Status:** Fixed ✅

## Problem

Custom headers were being duplicated in curl code samples when generating documentation. For example:

```shell
curl -X GET \
  /api/users \
  -H 'Authorization: value' \
  -H 'X-Custom-Header: value' \
  -H 'Authorization: value' \       # ❌ Duplicate
  -H 'X-Custom-Header: value'       # ❌ Duplicate
```

Each header appeared **twice** in the generated curl commands.

## Root Cause Analysis

### Issue 1: Mustache Template Bug (Line 179)

**File:** `packages/markdown/templates/main.mustache`

**Problem:**
```mustache
{{#headers}}{{#headers}} \
  -H '{{{name}}}: {{{example}}}'{{/headers}}{{/headers}}
```

The template had a **nested loop** over the same `headers` array. Since `endpoint.headers` is already an array of header objects, the outer loop iterates over headers, then the inner loop iterates over the same headers again, causing each header to be rendered multiple times.

**Why This Happened:**
Likely a copy-paste error or misunderstanding of Mustache's context model. The outer `{{#headers}}` sets the context to each header object, so there should be no inner loop.

### Issue 2: Logic Bug in OpenApiProcessor (Line 925-941)

**File:** `packages/core/utils/OpenApiProcessor.js`

**Problem:**
```javascript
processHeaders(parameters, operation, spec) {
  const headers = parameters
    .filter(param => param.in === 'header')
    .map(param => ({
      name: param.name,
      example: 'value'
    }));

  // Add authorization headers if operation requires authentication
  if (this.operationRequiresAuth(operation, spec)) {
    const authHeader = this.getAuthorizationHeader(spec);
    if (authHeader) {
      headers.push(authHeader);  // ❌ No check for duplicates
    }
  }

  return headers;
}
```

The method extracts all header parameters, then unconditionally adds an authorization header if the spec has security schemes. This causes duplication when:
1. The OpenAPI spec explicitly defines `Authorization` as a parameter
2. The spec also has `components.securitySchemes` defined

**Example Scenario:**
```yaml
paths:
  /api/users:
    get:
      parameters:
        - name: Authorization  # Explicit parameter
          in: header
          # ...
      responses:
        # ...

components:
  securitySchemes:
    bearerAuth:              # Security scheme defined
      type: http
      scheme: bearer
```

In this case, `Authorization` would be added twice:
1. Once from the explicit parameter (line 927-931)
2. Once from the security scheme (line 937)

## Solution

### Fix 1: Remove Nested Mustache Loop

**File:** `packages/markdown/templates/main.mustache:179-180`

**Before:**
```mustache
{{#headers}}{{#headers}} \
  -H '{{{name}}}: {{{example}}}'{{/headers}}{{/headers}}
```

**After:**
```mustache
{{#headers}} \
  -H '{{{name}}}: {{{example}}}'{{/headers}}
```

**Impact:** Removes the nested loop, ensuring each header is rendered exactly once.

### Fix 2: Add Duplicate Check in OpenApiProcessor

**File:** `packages/core/utils/OpenApiProcessor.js:925-948`

**Before:**
```javascript
if (this.operationRequiresAuth(operation, spec)) {
  const authHeader = this.getAuthorizationHeader(spec);
  if (authHeader) {
    headers.push(authHeader);  // ❌ No deduplication
  }
}
```

**After:**
```javascript
if (this.operationRequiresAuth(operation, spec)) {
  const authHeader = this.getAuthorizationHeader(spec);
  if (authHeader) {
    // Only add if not already present in headers
    const hasAuthHeader = headers.some(h =>
      h.name.toLowerCase() === authHeader.name.toLowerCase()
    );
    if (!hasAuthHeader) {
      headers.push(authHeader);  // ✅ Deduplicated
    }
  }
}
```

**Impact:** Prevents duplicate authorization headers by checking if a header with the same name (case-insensitive) already exists before adding.

## Verification

### Test Case

Created a test OpenAPI spec with explicit header parameters:

```json
{
  "openapi": "3.0.3",
  "info": {
    "title": "Header Duplication Test",
    "version": "1.0.0"
  },
  "paths": {
    "/api/users": {
      "get": {
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "schema": { "type": "string" },
            "example": "Bearer token123"
          },
          {
            "name": "X-Custom-Header",
            "in": "header",
            "required": false,
            "schema": { "type": "string" },
            "example": "custom-value"
          }
        ],
        "responses": {
          "200": { "description": "Success" }
        }
      }
    }
  }
}
```

### Before Fix

```shell
curl -X GET \
  /api/users \
  -H 'Authorization: value' \
  -H 'X-Custom-Header: value' \
  -H 'Authorization: value' \       # ❌ Duplicate
  -H 'X-Custom-Header: value'       # ❌ Duplicate
```

### After Fix

```shell
curl -X GET \
  /api/users \
  -H 'Authorization: value' \       # ✅ Once
  -H 'X-Custom-Header: value'       # ✅ Once
```

### Test Suite Results

All 70 tests pass with zero regressions:

```
Test Suites: 7 passed, 7 total
Tests:       70 passed, 70 total
Snapshots:   0 total
Time:        1.9s
```

Specific tests validating header handling:
- `packages/confluence/test/header-parameters.test.js` (7 tests) ✅
- `packages/confluence/test/components-and-refs.test.js` (9 tests) ✅
- `packages/core/test/openapi.test.js` (parameter extraction) ✅

## Impact Analysis

### Who Was Affected

**Users generating documentation with:**
1. Explicit header parameters in OpenAPI specs
2. Security schemes defined in `components.securitySchemes`
3. Both of the above (worst case - quadruple duplication)

**Generators Affected:**
- ✅ @confytome/markdown (uses `main.mustache`)
- ✅ @confytome/confluence (inherits from markdown)
- ❌ @confytome/html (different template)
- ❌ @confytome/swagger (uses Swagger UI)
- ❌ @confytome/postman (different format)

### Severity

**High** - User-facing bug producing incorrect documentation:
- Generated curl commands would fail or behave unexpectedly
- Duplicate headers might confuse API consumers
- Could cause HTTP 400 errors if servers reject duplicate headers

### Related Issues

This bug would have been caught earlier if:
1. Tests included specs with both explicit header parameters AND security schemes
2. Test assertions checked for exact header count in curl commands
3. Visual inspection of generated markdown was part of the test suite

## Lessons Learned

### Prevention Strategies

1. **Avoid Nested Loops in Templates**
   - Always verify Mustache context before adding loops
   - Use `{{#array}}{{.}}{{/array}}` for simple iteration
   - Document expected data structure in comments

2. **Always Check for Duplicates When Merging**
   - When combining arrays from multiple sources, deduplicate
   - Use case-insensitive comparison for header names (HTTP standard)
   - Consider using `Set` for automatic deduplication

3. **Test with Overlapping Scenarios**
   - Explicit parameters + security schemes
   - Multiple auth methods
   - Global vs operation-level security

### Code Review Checklist

When reviewing template changes:
- [ ] Check for nested loops over the same array
- [ ] Verify data structure matches template expectations
- [ ] Test with minimal and maximal data scenarios
- [ ] Check generated output visually, not just programmatically

When reviewing array merge logic:
- [ ] Check for duplicate prevention
- [ ] Use case-insensitive comparison for identifiers
- [ ] Document merge strategy (union, intersection, override)
- [ ] Add tests for overlapping scenarios

## Files Modified

1. **`packages/markdown/templates/main.mustache`** - Fixed nested loop (line 179)
2. **`packages/core/utils/OpenApiProcessor.js`** - Added duplicate check (lines 938-945)

## Deployment Notes

This fix is **backward compatible**:
- No API changes
- No breaking changes to generator behavior
- Only fixes incorrect output
- All existing tests pass

**Recommended Action:** Immediate deployment to prevent incorrect documentation generation.

## Future Enhancements

Consider these improvements in future versions:

1. **Template Validation**
   - Add linter to detect common Mustache mistakes
   - Warn on nested loops over same context
   - Validate data structure matches template expectations

2. **Test Coverage**
   - Add visual regression tests for generated markdown
   - Test curl command validity with real HTTP requests
   - Add "overlapping scenarios" test suite

3. **Header Management**
   - Consider a dedicated `HeaderManager` class
   - Centralize header deduplication logic
   - Support header priorities (explicit > inferred)

## Related Documentation

- [ADR-021: Maintainability Assessment](./docs/adrs/adr-021-maintainability-assessment-post-test-enhancement-2025-10.md)
- [CLI Consistency Documentation](./docs/CLI-CONSISTENCY.md)
- [OpenAPI Parameter Handling](./packages/core/utils/OpenApiProcessor.js#L925)
- [Markdown Template Reference](./packages/markdown/templates/main.mustache)
